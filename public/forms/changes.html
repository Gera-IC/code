<!--
	It depends on "code editor"
-->

<div data---="viewbox__codechanges__margin:51;parent:.ui-dockable-body;scrollbar:1">
	<div data-bind="!codechanges__template">
		<script type="text/html">
			{{ if value.group.length }}
			<div class="changedfiles" style="margin-bottom:5px">
				<div><i class="far fa-clock-o"></i>@(Last changed files)</div>
				<div>
				{{ foreach m in value.group }}
					<div class="changefile">
						<div class="path exec" data-exec="codechanges/load" data-path="{{ m }}"><i class="far fa-file-alt"></i>{{ m }}</div>
					</div>
				{{ end }}
				</div>
			</div>
			{{ fi }}
			{{ foreach m in value.files }}
				<div class="changeitem exec" data-exec="codechanges/load" data-path="{{ m.path }}">
					<div class="photo">{{ m.user | initials }}</div>
					<div class="meta">
						<div class="path"><span>+{{ m.changes }}</span>{{ m.path }}</div>
						<div class="user">{{ m.date | time2 }}<span class="badge badge-gray badge-small">{{ m.type }}</span><span title="@(Spent time:) {{ m.time | timespent }}">{{ m.user }}</span></div>
					</div>
				</div>
			{{ end }}
		</script>
	</div>
</div>

<script>
	PLUGIN('codechanges', function(exports) {

		exports.reload = function() {
			SETTER('dockable/show', 'prop');
			exports.refresh();
		};

		exports.load = function(el) {
			SETTER('tree/selectpath', el.attrd('path') || '');
		};

		exports.refresh = function() {
			var qs = {};
			qs.path = code.editor.path;
			AJAX('GET /api/projects/{id}/changes/'.arg(code.data), qs, function(response) {
				response.quicksort('date', false);

				var changes = {};

				for (var i = 0; i < response.length; i++) {
					var item = response[i];
					changes[item.path] = (changes[item.path] || 0) + 1;
				}

				SET('codechanges', { files: response, group: Object.keys(changes) });
			});
		};

		ON('knockknock', function(counter) {
			if (common.form === 'changes')
				exports.refresh();
		});
	})
</script>