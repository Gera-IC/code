<div data-bind="%projectsvisible__show" class="projectslist hidden">
	<ul data-jc="listmenu__code.data.id__datasource:code.projects;selector:li">
		<script type="text/html">
			<li class="exec" data-exec="code/project" data-id="{{ id }}"><i class="fa fa-project-diagram"></i>{{ name }}</li>
		</script>
	</ul>
</div>

<div id="panel">
	<section class="project exec" data-exec="code/projects" data-bind="!code.data__html b:value.name__title:value.name"><i class="fa fa-caret-down"></i><b>@(Choose project)</b></section>
	<div class="panel-scroller fullheight" data-margin="36">
		<div data-jc="tree__code.tree__exec:code/open;options:code/options;rename:code/rename;first:false;upload:code/upload"></div>
	</div>
	<section class="status invisible" data-bind="code.data__invisible:!value">
		<button title="@(Create file)" class="exec" data-name="file" data-exec="code/statusform"><i class="fa fa-file-text-o"></i></button>
		<button title="@(Create folder)" class="exec" data-name="directory" data-exec="code/statusform"><i class="fa fa-folder"></i></button>
		<button title="@(All uncomplete tasks)" class="exec" data-name="directory" data-exec="code/tasks_uncomplete"><i class="fa fa-tasks"></i></button>
		<button title="@(Users)" class="exec" data-name="directory" data-exec="code/usersonline"><i class="fa fa-users"></i></button>
	</section>
</div>

<div id="body">
	<section class="tabs">
		<a href="#" data-bind="code.data.url__href__show" target="_blank" class="preview" title="@(Preview)"><i class="fa fa-globe"></i></a>
		<span class="options exec hidden" data-exec="code/options_editor" data-bind="code.editor.path__show"><i class="fa fa-cog"></i></span>
		<nav data-jc="tabmenu__code.editor.path__datasource:code.open;selector:span;exec:code/opentab;reorder:code/savetabs">
			<script type="text/html">
				<span data-value="{{ path }}"{{ if modified }} class="modified"{{ fi }} title="{{ name }}"><i class="fa exec" data-exec="code/close"></i>{{ name }}</span>
			</script>
		</nav>
	</section>
	<div id="content" data-margin="36">
		<div class="alert-saved hidden exec" data-bind="code.saved__show__html b" data-exec="code/syncsave"><i class="fa fa-warning"></i><b></b> @(has replaced content of this file on the server.)</div>
		<div data-bind="code.editor.path__show">
			<div data-jc="editor__code.editor.body__height:100%;shortcut:code/shortcut;contextmenu:code/contextmenu;cursor:code/cursorposition;sync:code/sync"></div>
		</div>
		<div class="messages">
			<div class="alert hidden" data-bind="code.backup__show" data-name="backup"><i class="fa fa-times exec" data-exec="code/warning"></i><i class="fa fa-warning"></i>@(Content of this file wasn't be saved before. Do you want to restore it?) <span class="link exec" data-name="restore" data-exec="code/warning">@(Restore)</span> @(or) <span class="link exec" data-exec="code/warning">@(Cancel)</span>.</div>
			<div class="alert hidden" data-bind="code.multiple__show" data-name="multiple"><i class="fa fa-times exec" data-exec="code/warning"></i><i class="fa fa-users"></i>@(Be careful because another user is editing content of this file.) <span class="link exec b" data-exec="code/syncdata"><i class="fa fa-refresh fa-spin mr5"></i>@(Synchronize)</span> @(or) <span class="link exec" data-exec="code/warning">@(Cancel)</span>.</div>
		</div>
	</div>
	<section class="status invisible" data-bind="code.data__invisible:!value">
		<div data-bind="code.usersproject__template" class="status-collaborators">
			<script type="text/html">
				{{ foreach m in value }}
					{{ m.name | initials }}
				{{ end }}
			</script>
		</div>
		<div data-bind="JSHINT.errors__html b:value?value.length:0__.red:value && value.length>0" class="status-alerts exec" data-exec="code/warnings">
			<i class="fa fa-warning"></i><b>0</b>
		</div>
	</section>
</div>

<div data-jc="statusform__code.statusform.name__exec:code/statusform" class="statusform hidden">
	<div class="statusform-item hidden" data-name="file">
		<input type="text" placeholder="@(Enter filename.js)" />
	</div>
	<div class="statusform-item hidden" data-name="directory">
		<input type="text" placeholder="@(Enter a folder name)" />
	</div>
	<div class="statusform-item hidden" data-name="commit">
		<input type="text" placeholder="@(Describe changes for this file)" />
	</div>
</div>

<div class="collaborators hidden" data-bind="code.editor.path__show">
	<div class="tools">
		<span title="@(Tasks)" class="exec" data-path="common.form" data-value="'tasks'"><b data-bind="codetasks.items --> code/codetasks_unsolved__show:value>0__html:value" class="hidden"></b><i class="fa fa-tasks"></i></span>
	</div>
	<section data-bind="code.usersfile__template">
		<script type="text/html">
			{{ foreach m in value }}
				{{ m.name | initials }}
			{{ end }}
		</script>
	</section>
</div>

<div data-jc="importer__common.form__if:tasks;url:/forms/tasks.html"></div>

<script>

	var code = { SYNC: false };

	PLUGIN('code', function(exports) {

		var editor;
		var cache_synccur = { TYPE: 'synccur', id: user.id };
		var cache_scrollpos = {};

		FIND('editor', function(com) {
			editor = com;
		});

		exports.codetasks_unsolved = function(value) {
			var count = 0;
			if (value && value.length) {
				for (var i = 0; i < value.length; i++) {
					if (!value[i].solved)
						count++;
				}
			}
			return count > 99 ? 99 : count;
		};

		exports.syncdata = function() {
			SET('code.multiple', false);
			SETTER('loading', 'show');
			FUNC.wssend({ TYPE: 'syncsend', projectid: code.data.id, fileid: code.editor.path, connid: common.id });
		};

		exports.syncsave = function(msg) {

			var p = 'code.saved';

			if (!msg || msg instanceof jQuery) {
				SET(p, null);
				return;
			}

			if (msg.projectid === code.data.id && msg.fileid === code.editor.path) {
				SET(p, msg.user);
				setTimeout2(p, function() {
					SET(p, null);
				}, 5000);
			}
		};

		exports.synccursor = function(msg) {
			for (var i = 0; i < code.usersfile.length; i++) {
				var uf = code.usersfile[i];
				if (uf.id === msg.id) {
					editor.marker(uf.id, msg.fline, msg.fch, msg.tline, msg.tch, uf.color);
					return;
				}
			}
		};

		exports.reload = function() {

			EMIT('resize', exports.element);

			var id = READPARAMS().id;
			id && exports.load(id);

			SET('%projectsvisible', false);

			AJAX('GET /api/projects/', function(response) {

				SET('code.projects', response);

				var keys = Object.keys(localStorage);
				var projects = {};

				// Clears cache
				for (var i = 0; i < response.length; i++)
					projects[code.projects[i].id] = 1;

				for (var i = 0; i < keys.length; i++) {
					var id = keys[i].substring(0, keys[i].indexOf('_'));
					if (id && id.length > 15 && !projects[id])
						localStorage.removeItem(keys[i]);
				}
			});
		};

		exports.contextmenu = function(e, editor) {
			var items = [];
			var editor = exports.element.FIND('editor').editor;

			editor.getSelections().join('').length && items.push({ name: '@(Copy)', icon: 'copy', command: 'copy' });
			items.push({ name: '@(Encode)', icon: 'code', value: 'encode' });
			items.push({ name: '@(Decode)', icon: 'broom', value: 'decode' });

			SETTER('menu', 'showxy', e.pageX, e.pageY, items, function(value) {

				if (value.command) {
					editor.focus();
					setTimeout(function() {
						document.execCommand(value.command, true);
					}, 100);
					return;
				}

				setTimeout(function() {
					var items = [];

					if (value.value === 'encode') {
						items.push({ name: '@(Base64)', icon: 'chevron-right', value: 'btoa' });
						items.push({ name: '@(Encode URI)', icon: 'chevron-right', value: 'encodeURIComponent' });
						items.push({ name: '@(Escape)', icon: 'chevron-right', value: 'escape' });
						items.push({ name: '@(Slug)', icon: 'chevron-right', value: 'slug' });
					} else {
						items.push({ name: '@(Base64)', icon: 'chevron-right', value: 'atob' });
						items.push({ name: '@(Decode URI)', icon: 'chevron-right', value: 'decodeURIComponent' });
						items.push({ name: '@(Unescape)', icon: 'chevron-right', value: 'unescape' });
					}

					SETTER('menu', 'showxy', e.pageX, e.pageY, items, function(value) {
						var sel = editor.getSelections();
						switch (value.value) {
							case 'encodeURIComponent':
							case 'decodeURIComponent':
							case 'atob':
							case 'btoa':
							case 'escape':
							case 'unescape':
								for (var i = 0; i < sel.length; i++)
									sel[i] = window[value.value](sel[i]);
								editor.replaceSelections(sel);
								break;
							case 'slug':
								for (var i = 0; i < sel.length; i++)
									sel[i] = sel[i][value.value]();
								editor.replaceSelections(sel);
								break;
						}
					});

				}, 200);
			});
		};

		WATCH('code.editor.body', function(path, value, type) {

			// cache
			if (type === 1 && code.editor.body) {
				exports.cache_set();
				if (!code.current.modified) {
					code.current.modified = true;
					exports.element.find('section.tabs').find('span[data-value="{0}"]'.format(code.current.path)).aclass('modified');
				}
			}

			setTimeout2('jshint', function() {
				BIND('JSHINT.errors');
			}, 1000);
		});

		exports.warning = function(el) {
			var parent = el.closest('.alert');
			switch (parent.attrd('name')) {
				case 'backup':
					if (el.attrd('name') === 'restore')
						SET('code.editor.body', exports.cache_get(code.editor.path));
					else
						exports.cache_rem(code.editor.path);
					SET('code.backup', false);
					break;
				case 'multiple':
					code.SYNC = false;
					if (code.backup) {
						exports.cache_rem(code.editor.path);
						SET('code.backup', false);
					}
					SET('code.multiple', false);
					break;
			}
		};

		exports.sync = function(data) {
			// Determines how many people is editing this file?
			if (code.usersfile.length > 1 && code.SYNC)
				FUNC.wssend({ TYPE: 'sync', data: STRINGIFY(data), id: common.id });
		};

		exports.rename = function(item, val, callback) {

			var data = {};

			data.oldpath = item.path;
			data.newpath = val;

			if (data.newpath === data.oldpath) {
				callback(false);
				return;
			}

			SETTER('loading', 'show');
			AJAX('POST /api/files/{id}/rename/'.arg(code.data), data, function(response) {
				SETTER('loading', 'hide', 500);
				exports.closetab(data.oldpath);
				callback(response.success);
				exports.load(code.data.id, true);
			});
		};

		exports.shortcut = function(type) {
			switch (type) {
				case 'nexttab':
					var index = code.current ? code.open.indexOf(code.current) : -1;
					if (index !== -1) {
						var next = code.open[index + 1];
						if (next == null && index !== 0)
							next = code.open[0];
						next && exports.opentab(next.path);
					}
					break;
				case 'F5':
					FUNC.editor_reload();
					break;
				case 'save':
					exports.save();
					break;
				case 'close':
					setTimeout2('closetab', exports.close, 200);
					break;
			}
		};

		exports.upload = function(node, files) {

			var data = new FormData();

			data.append('path', node ? FUNC.getPath(node.path) : '/');

			for (var i = 0, length = files.length; i < length; i++)
				data.append('file' + i, files[i]);

			UPLOAD('POST /api/projects/{id}/upload/'.arg(code.data), data, function(response) {
				if (response instanceof Array)
					FUNC.warning(response);
				else
					exports.load(code.data.id, true);
			});
		};

		exports.open = function(item) {

			if (!item || item.children)
				return;

			var tab = code.open.findItem('path', item.path);
			if (tab && tab.loaded) {
				if (tab.path !== code.editor.path) {
					// check if the content has been modified
					exports.edit(tab);
					exports.savetabs();
				}
				return;
			}

			var newbie = false;
			var ext = item.path.substring(item.path.lastIndexOf('.') + 1).toLowerCase();

			switch (ext) {
				case 'pdf':
				case 'jpg':
				case 'ico':
				case 'jpeg':
				case 'png':
				case 'gif':
				case 'xls':
				case 'xlsx':
				case 'docx':
				case 'doc':
				case 'zip':
				case 'rar':
				case 'file':
				case 'nosql-binary':
					window.open('/api/download/{0}/?path={1}'.format(code.data.id, encodeURIComponent(item.path)));
					return;
			}

			AJAX('GET /api/projects/{id}/edit/'.arg(code.data), { path: item.path }, function(response) {


				if (!tab) {
					newbie = true;
					tab = {};
					tab.path = item.path;
					tab.name = item.name;
				}

				tab.loaded = true;
				tab.body = response;

				var cache = exports.cache_get(item.path);
				SET('code.backup', cache && cache !== response);

				newbie && PUSH('code.open', tab);
				exports.edit(tab);
				exports.savetabs();
				exports.element.SETTER('tree', 'select2', FUNC.treeindex(code.tree, item.path), true);
			});
		};

		exports.opentab = function(path) {
			exports.open({ children: null, path: path });
		};

		exports.options_editor = function(el) {

			var items = [];

			items.push({ value: 1, name: '@(Reload)', icon: 'refresh' });
			items.push({ value: 2, name: '@(Find)', icon: 'search', command: 'findPersistent' });
			items.push({ value: 2, name: '@(Replace)', icon: 'search', command: 'replaceAll' });

			if (navigator.userAgent.indexOf('Electron') !== -1 && window.require)
				items.push({ value: 3, name: '<b>@(Save locally)</b>', icon: 'code-branch' });

			SETTER('menu', 'show', 'left', el, items, function(item) {
				switch (item.value) {
					case 1:
						FUNC.editor_reload();
						break;
					case 2:
						setTimeout(function() {
							var editor = FIND('editor').editor;
							editor.focus();
							editor.execCommand(item.command);
						}, 200);
						break;
					case 3:
						var electronpath = require('electron').ipcRenderer.sendSync('getPath', { url: location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') });
						if (electronpath) {
							var filename = require('path').join(electronpath, FUNC.getName(code.data.repository).replace(/\.git$/i, ''), code.editor.path);
							require('fs').writeFile(filename, FUNC.rtrim(code.editor.body), function(err) {
								if (err)
									FUNC.warning(err.toString());
								else
									FUNC.success('<b>{0}</b> saved.'.format(filename));
							});
						} else
							FUNC.warning('A problem in path');
						break;
				}
			}, -5, -5);
		};

		exports.options = function(node, el) {

			var items = [];

			if (node.children) {
				items.push({ value: 'file', name: '@(Create file)', icon: 'file-text-o' });
				items.push({ value: 'directory', name: '@(Create directory)', icon: 'folder-o' });
			}

			items.push({ value: 3, name: '@(Rename)', icon: 'pencil' });
			items.push({ value: 255, name: '@(Remove)', icon: 'times-circle red' });

			SETTER('menu', 'show', 'right', el, items, function(item) {
				switch (item.value) {
					case 'file':
					case 'directory':
						SET('code.statusform.name', item.value);
						code.statusform.path = node.path + (node.path ? '/' : '');
						break;
					case 3:
						setTimeout(function() {
							exports.element.SETTER('tree', 'rename', node.$pointer);
						}, 500);
						break;
					case 255:
						SETTER('confirm', 'show', '@(Are you sure you want to remove <b>{0}</b>?)'.format(node.path), ['"trash-o"@(Remove)', '@(Cancel)'], function(index) {
							if (!index) {
								var data = {};
								data.path = node.path;
								SETTER('loading', 'show');
								AJAX('POST /api/files/{id}/remove/'.arg(code.data), data, function() {
									SETTER('loading', 'hide', 100);
									FUNC.success('@(Removed successfully: <b>{0}</b>.)'.format(data.path));
									SET('code.tree', FUNC.treeremove(code.tree, node.path));
								});
							}
						});
						break;
				}
			}, 5, -35);
		};

		exports.close = function() {
			if (code.current.modified) {
				SETTER('confirm', 'show', '@(Do you want to save the changes you made?)', ['"floppy-o"@(Save changes)', '@(Discard)'], function(index) {
					if (index)
						exports.closeforce();
					else
						exports.save(true);
				});
			} else
				exports.closeforce();
		};

		exports.closeforce = function() {
			common.form && SET('common.form', '');
			exports.closetab(code.current.path);
		};

		exports.closetab = function(path) {
			var tab = code.open.findItem('path', path);
			if (tab == null)
				return;
			var index = code.open.indexOf(tab);
			code.open.splice(index, 1);
			exports.cache_rem(tab.path);
			UPDATE('code.open');
			if (tab.path === code.editor.path) {
				if (code.open.length) {
					if (index - 1 > -1)
						index -= 1;
					else
						index = 0;
					exports.opentab(code.open[index].path);
				} else {
					FUNC.wsopen(code.data.id, '');
					SET('code.multiple', false);
					SET('code.backup', false);
					$('#body').rclass('warning');
					SET('code.editor', {});
					exports.element.RECONFIGURE('editor', 'disabled:true');
				}
			}
			exports.savetabs();
		};

		exports.edit = function(tab) {

			if (typeof(tab) === 'string')
				tab = code.open.findItem('path', tab);

			var prev = GET('code.editor.path');
			if (prev && prev !== tab.path) {
				prev = code.open.findItem('path', prev);
				if (prev)
					prev.doc = editor.copy(true);
			}

			code.editor.loaded = false;
			editor.clear(true);

			var ext = tab.path.substring(tab.path.lastIndexOf('.') + 1).toLowerCase();
			var mode;

			switch (ext) {
				case 'src/config':
				case 'src/config-release':
				case 'src/config-debug':
				case 'src/config-test':
				case 'src/versions':
				case 'src/dependencies':
				case 'src/sitemap':
				case 'src/workflows':
				case '/config':
				case '/config-release':
				case '/config-debug':
				case '/config-test':
				case '/versions':
				case '/dependencies':
				case '/sitemap':
				case '/workflows':
				case 'resource':
					mode = 'totaljsresources';
					break;
				case 'js':
					mode = 'javascript';
					break;
				case 'json':
				case 'nosql':
					mode = 'application/ld+json';
					break;
				case 'css':
					mode = 'css';
					break;
				case 'sh':
					mode = 'shell';
					break;
				case 'sql':
					mode = 'sql';
					break;
				case 'md':
					mode = 'markdown';
					break;
				case 'xml':
					mode = 'xml';
					break;
				case 'log':
				case 'txt':
				case 'table':
					mode = 'plain';
					break;
				case 'nosql':
					mode = 'json';
					break;
				case 'html':
				case 'htm':
				default:
					mode = 'totaljs';
					break;
			}

			SET('code.editor.path', tab.path);
			SET('code.editor.name', tab.name);
			code.editor.hash = HASH(tab.path);

			if (JSHINT.errors) {
				JSHINT.errors.length = 0;
				BIND('JSHINT.errors');
			}

			if (tab.doc) {
				SETR('code.editor.body', tab.body, 'skip');
				editor.paste(tab.doc);
			} else {
				editor.clear();
				SETR('code.editor.body', tab.body, 2);
				editor.paste(editor.copy(false));
			}

			setTimeout2('code.autocomplete', editor.rebuild_autocomplete, 1000);
			code.current = tab;
			editor.reconfigure('disabled:false;mode:' + mode);
			FUNC.wsopen(code.data.id, code.current.path);

			code.editor.loaded = true;

			!tab.doc && setTimeout(function() {
				editor.editor.refresh();
				var cache = exports.cache_getscroll(code.current.path);
				if (cache) {
					editor.editor.scrollTo(cache.x || 0, cache.y || 0);
					editor.editor.setCursor({ line: cache.line || 0, ch: cache.ch || 0 });
					editor.editor.focus();
				} else {
					editor.editor.scrollTo(0, 0);
					editor.editor.setCursor(0);
				}
			}, 250);

			// Refresh tasks
			AJAX('GET /api/projects/{id}/tasks/'.arg(code.data), { path: code.current.path }, 'codetasks.items');
		};

		exports.load = function(id, skip) {

			SETTER('loading', 'show');

			AJAX('GET /api/projects/{0}/files/'.format(id), function(response) {

				if (response instanceof Array) {
					FUNC.warning(response);
					return;
				}

				var tree = [];

				for (var i = 0; i < response.directories.length; i++)
					FUNC.treeappend(tree, response.directories[i]);

				for (var i = 0; i < response.files.length; i++)
					FUNC.treeappend(tree, response.files[i], true);

				var item = tree.findItem('name', '#');
				if (item) {
					tree = tree.remove('name', '#');
					for (var i = 0; i < item.children.length; i++)
						tree.push(item.children[i]);
				}

				if (!skip)
					exports.element.SETTER('tree', 'clear');

				SET('code.data', response);
				SET('code.tree', tree);

				if (!skip) {
					SET('code.editor', {});
					SET('code.open', []);
					SET('code.usersproject', EMPTYARRAY);
					SET('code.usersfile', EMPTYARRAY);
					SET('code.multiple', false);
					$('#body').rclass('warning');
					setTimeout(exports.restoretabs, 500);
				}

				SETTER('loading', 'hide', 1000);
			});
		};

		exports.project = function(el) {
			var id = el.attrd('id');
			REDIRECT('/?id=' + id);
		};

		exports.projects = function() {
			TOGGLE('%projectsvisible', true);
		};

		exports.save = function(close, comment) {

			if (BLOCKED('code_saving', 2000))
				return;

			var data = {};
			data.path = code.editor.path;
			data.body = FUNC.rtrim(code.editor.body);

			if (comment) {
				data.comment = comment;
				data.commit = true;
			}

			code.current.modified = false;
			exports.cache_rem(code.current.path);
			exports.element.find('section.tabs').find('span[data-value="{0}"]'.format(code.current.path)).rclass('modified');

			SETTER('loading', 'show');
			AJAX('POST /api/files/{id}/ REPEAT'.arg(code.data), data, function(response) {
				SETTER('loading', 'hide', 500);
				if (close === true)
					exports.closeforce();
				FUNC.wssend({ TYPE: 'save', projectid: code.data.id, fileid: code.editor.path, id: user.id, user: user.name });
				FUNC.success('@(<b>{0}</b> saved)'.format(data.path));
			});
		};

		exports.savetabs = function() {

			var arr = [];

			for (var i = 0; i < code.open.length; i++) {
				var tab = code.open[i];
				var data = {};
				data.path = tab.path;
				if (tab.path === code.current.path)
					data.focused = true;
				arr.push(data);
			}

			localStorage.setItem(code.data.id + '_tabs', STRINGIFY(arr));
		};

		exports.restoretabs = function() {
			var open = localStorage.getItem(code.data.id + '_tabs');
			if (!open)
				return;

			open = PARSE(open);

			var selected = null;
			var tabs = [];

			for (var i = 0; i < open.length; i++) {
				var tab = open[i];
				var fileindex = code.data.files.indexOf(tab.path);
				if (fileindex !== -1) {
					tab.name = code.data.files[fileindex];
					if (tab.name) {
						tab.name = tab.name.split('/');
						tab.name = tab.name[tab.name.length - 1];
						tab.body = '';
						tabs.push(tab);
					}

					if (tab.focused) {
						delete tab.focused;
						selected = tab;
					}
				}
			}

			tabs.length && SET('code.open', tabs);
			selected && exports.open({ children: null, path: selected.path, name: selected.name });
		};

		var colorclasses = {};

		exports.collaboration = function(msg) {

			if (code.data == null)
				return;

			if (msg.projectid === code.data.id)
				SET('code.usersproject', msg.project);

			if (code.editor && msg.fileid === code.editor.path) {
				SET('code.usersfile', msg.file);
				var colors = [];
				for (var i = 0; i < msg.file.length; i++) {
					var usr = msg.file[i];
					usr.color = Thelpers.initials(usr.name, true);
				}
				colors.length && CSS(colors.join(''));
			}

			editor && editor.clearmarkers();
			$('#body').tclass('warning', code.usersfile && code.usersfile.length > 1);
			SET('code.multiple', !!(code.usersfile && code.usersfile.length > 1));
		};

		exports.statusform = function(name, value) {

			if (name instanceof jQuery) {
				// element
				SET('code.statusform.path', '');
				SET('code.statusform.name', name.attrd('name'));
				return;
			}

			if (!value)
				return;

			var data = {};

			data.path = (code.statusform.path || '') + value;
			data.folder = name !== 'file';

			SETTER('loading', 'show');
			AJAX('POST /api/files/{id}/create/'.arg(code.data), data, function(response) {
				SETTER('loading', 'hide', 500);
				if (response.success)
					exports.load(code.data.id, true);
				else
					FUNC.warning(response);
			});
		};

		exports.usersonline = function(el) {
			AJAX('GET /api/users/online/', function(response) {
				SETTER('infopanel', 'show', el, function(el) {

					var builder = [];
					for (var i = 0; i < 10; i++) {
						var user = response[i];
						if (user == null)
							break;
						builder.push('<div class="infopanel-online"><span>{0}</span><b>{1}</b></div>'.format(user.name, user.project || '@(No file open)'));
					}

					!builder.length && FUNC.warning('@(No-one works.)');
					el.html(builder.join(''));
				}, 0, -10);
			});
		};

		exports.opentab2 = function(el) {
			exports.element.SETTER('tree', 'selectpath', el.attrd('path'));
			SET('common.form', 'tasks', 1000);
		};

		exports.tasks_uncomplete = function(el, e) {
			AJAX('GET /api/projects/{id}/tasks/uncomplete/'.arg(code.data), function(response) {
				SETTER('infopanel', 'show', el, function(el) {
					var keys = Object.keys(response);
					var builder = [];
					for (var i = 0; i < 10; i++) {
						var key = keys[i];
						if (key == null)
							break;
						var value = response[key];
						builder.push('<div class="infopanel-line exec" data-exec="code/opentab2" data-path="{0}"><b>{1}</b><span>{0}</span></div>'.format(key, value));
					}

					!builder.length && FUNC.warning('@(Project doesn\'t contain any tasks.)');
					el.html(builder.join(''));
				}, 0, -10);
			});
		};

		exports.warnings = function(el, e) {
			SETTER('infopanel', 'show', el, function(el) {
				var builder = [];
				for (var i = 0; i < 10; i++) {
					var err = JSHINT.errors && JSHINT.errors[i];
					err && builder.push('<div class="infopanel-line exec" data-exec="code/warnings_goto" data-pos="{1}x{2}"><b>:{1}</b><span>{0}</span></div>'.format(err.reason || err.raw, err.line, err.character));
				}
				!builder.length && FUNC.warning('@(File doesn\'t contain any warnings.)');
				el.html(builder.join(''));
			});
		};

		exports.warnings_goto = function(el) {
			var pos = el.attrd('pos').split('x');
			editor.editor.setCursor({ line: +pos[0] - 1, char: +pos[1] }, 200);
			editor.editor.focus();
		};

		exports.cursorposition = function(editor) {

			if (code.usersfile.length > 1 && code.SYNC) {
				var a = editor.getCursor(true);
				var b = editor.getCursor(false);
				cache_synccur.fline = a.line;
				cache_synccur.fch = a.ch;
				cache_synccur.tline = b.line;
				cache_synccur.tch = b.ch;
				FUNC.wssend(cache_synccur);
			}

			setTimeout2('savescrollposition', function(editor) {
				if (!code.editor.loaded)
					return;
				var info = editor.getScrollInfo();
				var cur = editor.getCursor();
				var key = code.data.id + '_' + code.editor.hash + '_scroll';
				if (info.left || info.top || cur.line) {
					cache_scrollpos.x = info.left;
					cache_scrollpos.y = info.top;
					cache_scrollpos.line = info.line;
					cache_scrollpos.ch = info.ch;
					localStorage.setItem(key,  STRINGIFY(cache_scrollpos));
				} else
					localStorage.removeItem(key);

			}, 300, null, editor);
		};

		// Internal cache
		// For unexpect of closing browser
		exports.cache_set = function() {
			if (code.editor.path) {
				var key = code.data.id + '_' + code.editor.hash;
				localStorage.setItem(key, code.editor.body);
			}
		};

		exports.cache_get = function(path) {
			if (path) {
				var key = code.data.id + '_' + HASH(path);
				return localStorage.getItem(key);
			}
		};

		exports.cache_getscroll = function(path) {
			if (path) {
				var key = code.data.id + '_' + HASH(path) + '_scroll';
				var obj = localStorage.getItem(key);
				return obj ? PARSE(obj) : null;
			}
		};

		exports.cache_rem = function() {
			if (code.editor.path) {
				var key = code.data.id + '_' + HASH(code.editor.path);
				localStorage.removeItem(key);
			}
		};
	});

</script>